<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ì—Ä–∏–º—É–∞—Ä –§–∏–Ω–∞–Ω—Å–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(15,23,42,0.95) 40%, #020617 80%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    /* –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ç—É–º–∞–Ω */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(244, 114, 182, 0.18), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(129, 140, 248, 0.18), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.8;
      z-index: -1;
      animation: floatGlow 18s ease-in-out infinite alternate;
    }

    @keyframes floatGlow {
      from { transform: translate3d(0, 0, 0); }
      to   { transform: translate3d(0, -20px, 0); }
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    header {
      text-align: center;
      padding: 8px 0 4px;
    }

    header h1 {
      font-family: "Playfair Display", system-ui, serif;
      font-size: 24px;
      letter-spacing: 0.05em;
      margin: 0;
      color: #e5e7ff;
      text-shadow: 0 0 8px rgba(167, 139, 250, 0.6);
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: #a5b4fc;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(76,29,149,0.35), rgba(15,23,42,0.95));
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow:
        0 18px 35px rgba(15,23,42,0.8),
        0 0 0 1px rgba(148,163,184,0.18);
      border: 1px solid rgba(129, 140, 248, 0.35);
      backdrop-filter: blur(14px);
    }

    .card.accent-income {
      border-color: rgba(45,212,191,0.7);
      background: radial-gradient(circle at top right, rgba(21,128,61,0.28), rgba(15,23,42,0.96));
    }

    .card.accent-expense {
      border-color: rgba(248,113,113,0.7);
      background: radial-gradient(circle at top left, rgba(147,51,234,0.3), rgba(15,23,42,0.96));
    }

    .card-title {
      font-size: 13px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #c4b5fd;
    }

    .card-title span {
      font-family: "Playfair Display", serif;
      font-weight: 600;
    }

    label {
      font-size: 12px;
      display: block;
      margin-bottom: 4px;
      color: #c7d2fe;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 8px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }

    input::placeholder {
      color: #6b7280;
    }

    input:focus, select:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 1px rgba(168,85,247,0.7);
    }

    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 4px;
      font-family: "Inter", system-ui, sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #a855f7, #22c55e);
      color: #020617;
      box-shadow: 0 10px 25px rgba(148,163,184,0.35);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.92);
      color: #e5e7eb;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .btn-secondary:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(30,64,175,0.8);
    }

    .top-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 8px;
    }

    .filters-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .filters-row select {
      margin-bottom: 0;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 999px;
    }

    .filters-row span {
      font-size: 12px;
      color: #c7d2fe;
    }

    .stats-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .stats-total {
      font-size: 19px;
      font-weight: 600;
      background: linear-gradient(120deg,#bfdbfe,#c4b5fd);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .stats-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    .cats {
      font-size: 13px;
      margin-top: 4px;
    }

    .cats div {
      display: flex;
      justify-content: space-between;
    }

    .kind-stats {
      font-size: 12px;
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
    }

    .kind-stats div {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }

    .hint {
      margin-top: 6px;
      font-size: 12px;
      color: #e0e7ff;
    }

    .list-empty {
      font-size: 13px;
      color: #9ca3af;
    }

    .badge-budget {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(30,64,175,0.7);
      color: #e0f2fe;
      margin-bottom: 6px;
    }

    .badge-budget span {
      font-size: 13px;
    }

    .item {
      display: flex;
      gap: 8px;
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.55);
      align-items: center;
      animation: fadeInUp 0.18s ease-out;
    }

    .item-main { flex: 1; }

    .item-line1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .item-amount {
      font-weight: 600;
      color: #22c55e;
    }

    .item-amount.expense {
      color: #f97373;
    }

    .item-cat {
      font-size: 12px;
      color: #c7d2fe;
    }

    .item-kind {
      font-size: 11px;
      color: #fde68a;
      margin-left: 4px;
    }

    .item-type-tag {
      font-size: 11px;
      color: #a5b4fc;
      margin-left: 6px;
    }

    .item-desc {
      font-size: 12px;
      margin-top: 2px;
      color: #e5e7eb;
    }

    .item-date {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .item button {
      width: auto;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(127,29,29,0.9);
      color: #fee2e2;
      border: 1px solid rgba(248,113,113,0.7);
    }

    .item button:hover {
      filter: brightness(1.05);
    }

    .chart {
      margin-top: 6px;
    }

    .chart-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .chart-label {
      width: 90px;
      color: #c7d2fe;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chart-bar-wrap {
      flex: 1;
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #1f2937;
      padding: 2px 3px;
    }

    .chart-value {
      width: 110px;
      text-align: right;
      font-size: 11px;
      color: #e5e7eb;
    }

    .chart-title {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      margin-bottom: 2px;
      font-style: italic;
    }

    .budget-progress-wrap {
      margin-top: 6px;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .budget-progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.35s ease-out, background 0.25s ease-out;
    }

    /* –î–ª—è overlap-–≥—Ä–∞—Ñ–∏–∫–∞ –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ */
    .chart-bar-pair {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chart-bar-expense,
    .chart-bar-income {
      height: 6px;
      border-radius: 999px;
      width: 0;
      transition: width 0.35s ease-out;
    }

    .chart-bar-expense {
      background: linear-gradient(90deg, #f97373, #ef4444);
    }

    .chart-bar-income {
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 360px) {
      .top-row { grid-template-columns: 1fr; }
    }

    /* üîÆ –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π splash-—ç–∫—Ä–∞–Ω */
    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(15,23,42,0.98) 40%, #020617 80%);
      z-index: 999;
      overflow: hidden;
      transition: opacity 0.7s ease-out;
    }

    .splash-hidden {
      opacity: 0;
      pointer-events: none;
    }

    .splash-orb {
      width: 120px;
      height: 120px;
      border-radius: 999px;
      border: 2px solid rgba(196,181,253,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow:
        0 0 25px rgba(129, 140, 248, 0.7),
        0 0 60px rgba(56, 189, 248, 0.4);
      animation: orbPulse 2.3s ease-in-out infinite;
    }

    .splash-orb::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: inherit;
      border: 1px dashed rgba(165,180,252,0.8);
      animation: orbSpin 9s linear infinite;
      opacity: 0.8;
    }

    .splash-orb-inner {
      width: 70px;
      height: 70px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #facc15, #f97316 40%, #4c1d95 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: 32px;
      text-shadow: 0 0 8px rgba(253,224,71,0.7);
    }

    .splash-title {
      margin-top: 16px;
      font-family: "Playfair Display", serif;
      font-size: 22px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7ff;
      text-shadow: 0 0 8px rgba(129,140,248,0.7);
      text-align: center;
    }

    .splash-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #c7d2fe;
      opacity: 0.9;
      text-align: center;
    }

    .splash-hint {
      position: absolute;
      bottom: 28px;
      font-size: 11px;
      color: #9ca3af;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    @keyframes orbPulse {
      0%   { transform: scale(1); box-shadow: 0 0 20px rgba(129, 140, 248, 0.6); }
      50%  { transform: scale(1.06); box-shadow: 0 0 35px rgba(129, 140, 248, 0.9); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(129, 140, 248, 0.6); }
    }

    @keyframes orbSpin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <!-- üîÆ Splash-—ç–∫—Ä–∞–Ω -->
  <div id="splash" class="splash">
    <div class="splash-orb">
      <div class="splash-orb-inner">G</div>
    </div>
    <div class="splash-title">–ì—Ä–∏–º—É–∞—Ä –§–∏–Ω–∞–Ω—Å–æ–≤</div>
    <div class="splash-subtitle">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ –º–∞–≥–∏–∏ –¥–µ–Ω–µ–≥...</div>
    <div class="splash-hint">–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–≤–∏—Ç–∫–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü</div>
  </div>

  <div class="app">
    <header>
      <h1>–õ–∏—á–Ω—ã–π –≥—Ä–∏–º—É–∞—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤</h1>
      <p>–ó–∞–ø–∏—Å–∏ –æ –¥–æ—Ö–æ–¥–∞—Ö –∏ —Ç—Ä–∞—Ç–∞—Ö, –Ω–µ–º–Ω–æ–≥–æ –º–∞–≥–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚ú®</p>
    </header>

    <!-- –ë—é–¥–∂–µ—Ç –∏ –ª–∏–º–∏—Ç—ã -->
    <section class="card">
      <div class="card-title"><span>–ë—é–¥–∂–µ—Ç –º–µ—Å—è—Ü–∞</span></div>

      <div class="badge-budget">
        ‚ú® <span>–ù–∞—Å—Ç—Ä–æ–π –ª–∏–º–∏—Ç—ã –∏ –Ω–∞–±–ª—é–¥–∞–π –∑–∞ –º–∞–≥–∏–µ–π —Ü–∏—Ñ—Ä</span>
      </div>

      <label for="monthlyBudget">–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü (‚ÇΩ)</label>
      <input id="monthlyBudget" type="number" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 60000" oninput="updateSettingsFromUI()" />

      <label for="baseLimit">–õ–∏–º–∏—Ç –±–∞–∑–æ–≤—ã—Ö —Ç—Ä–∞—Ç (‚ÇΩ)</label>
      <input id="baseLimit" type="number" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 40000" oninput="updateSettingsFromUI()" />

      <label for="flexLimit">–õ–∏–º–∏—Ç –≥–∏–±–∫–∏—Ö —Ç—Ä–∞—Ç (‚ÇΩ)</label>
      <input id="flexLimit" type="number" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15000" oninput="updateSettingsFromUI()" />

      <div class="budget-progress-wrap">
        <div class="budget-progress-bar" id="budgetBar"></div>
      </div>
      <div class="stats-sub" id="budgetInfo"></div>
    </section>

    <!-- –ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ -->
    <section class="card accent-expense">
      <div class="card-title"><span>–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</span></div>

      <div class="top-row">
        <div>
          <label for="amountExp">–°—É–º–º–∞ (‚ÇΩ)</label>
          <input id="amountExp" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 750" />
        </div>
        <div>
          <label for="dateExp">–î–∞—Ç–∞</label>
          <input id="dateExp" type="date" />
        </div>
      </div>

      <label for="categoryExp">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="categoryExp" onchange="autoKindByCategory()">
        <option>–ü—Ä–æ–¥—É–∫—Ç—ã</option>
        <option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
        <option>–ê–≤—Ç–æ</option>
        <option>–û–¥–µ–∂–¥–∞</option>
        <option>–ö–∞—Ñ–µ</option>
        <option>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
        <option>–°–≤—è–∑—å/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç</option>
        <option>–î–æ–º/–±—ã—Ç</option>
        <option>–î—Ä—É–≥–æ–µ</option>
      </select>

      <label for="kindExp">–¢–∏–ø —Ç—Ä–∞—Ç—ã</label>
      <select id="kindExp">
        <option value="–ë–∞–∑–æ–≤—ã–µ">–ë–∞–∑–æ–≤—ã–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)</option>
        <option value="–ì–∏–±–∫–∏–µ">–ì–∏–±–∫–∏–µ (—Ö–æ—Ç–µ–ª–∫–∏)</option>
      </select>

      <label for="descExp">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input id="descExp" type="text" placeholder="–ú–∞–≥–Ω–∏—Ç, –∑–∞–ø—Ä–∞–≤–∫–∞, –æ–¥–µ–∂–¥–∞..." />

      <button class="btn-primary" onclick="addExpense()">–ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
    </section>

    <!-- –ù–æ–≤—ã–π –¥–æ—Ö–æ–¥ -->
    <section class="card accent-income">
      <div class="card-title"><span>–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥</span></div>

      <div class="top-row">
        <div>
          <label for="amountInc">–°—É–º–º–∞ (‚ÇΩ)</label>
          <input id="amountInc" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50000" />
        </div>
        <div>
          <label for="dateInc">–î–∞—Ç–∞</label>
          <input id="dateInc" type="date" />
        </div>
      </div>

      <label for="categoryInc">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞</label>
      <select id="categoryInc">
        <option>–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
        <option>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</option>
        <option>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</option>
        <option>–ü–æ–¥–∞—Ä–æ–∫</option>
        <option>–î—Ä—É–≥–æ–µ</option>
      </select>

      <label for="descInc">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input id="descInc" type="text" placeholder="–ó–∞—Ä–ø–ª–∞—Ç–∞, —Ñ—Ä–∏–ª–∞–Ω—Å, –∫–µ—à–±—ç–∫..." />

      <button class="btn-primary" onclick="addIncome()">–ó–∞–ø–∏—Å–∞—Ç—å –¥–æ—Ö–æ–¥</button>
      <button class="btn-secondary" onclick="clearAll()" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
    </section>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section class="card">
      <div class="card-title"><span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></div>

      <div class="filters-row">
        <span>–ü–µ—Ä–∏–æ–¥:</span>
        <select id="period" onchange="render()">
          <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
      </div>

      <div class="stats-main">
        <div>
          <div class="stats-total" id="totalAmount">0 ‚ÇΩ</div>
          <div class="stats-sub" id="totalLabel">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
      </div>

      <div class="stats-sub" id="opsCount"></div>
      <div class="stats-sub" id="avgInfo"></div>
      <div class="stats-sub" id="incomeInfo"></div>

      <div class="cats" id="cats"></div>

      <div class="kind-stats" id="kindStats"></div>

      <div class="chart-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
      <div class="chart" id="chartCats"></div>

      <div class="chart-title">–î–æ—Ö–æ–¥—ã vs —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º</div>
      <div class="chart" id="chartDays"></div>

      <div class="hint" id="hint"></div>
    </section>

    <!-- –õ–µ–Ω—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π -->
    <section class="card" style="margin-bottom: 12px;">
      <div class="card-title"><span>–õ–µ–Ω—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π</span></div>
      <div id="list"></div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "expenses-v3";
    const SETTINGS_KEY = "expenses-settings-v1";

    let expenses = [];
    let settings = { monthlyBudget: 0, baseLimit: 0, flexLimit: 0 };

    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        expenses = raw ? JSON.parse(raw) : [];
      } catch (e) {
        expenses = [];
      }
    }

    function saveExpenses() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
    }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        settings = raw
          ? JSON.parse(raw)
          : { monthlyBudget: 0, baseLimit: 0, flexLimit: 0 };
      } catch (e) {
        settings = { monthlyBudget: 0, baseLimit: 0, flexLimit: 0 };
      }
    }

    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function syncSettingsToUI() {
      document.getElementById("monthlyBudget").value =
        settings.monthlyBudget || "";
      document.getElementById("baseLimit").value = settings.baseLimit || "";
      document.getElementById("flexLimit").value = settings.flexLimit || "";
    }

    function updateSettingsFromUI() {
      const mb = Number(document.getElementById("monthlyBudget").value) || 0;
      const bl = Number(document.getElementById("baseLimit").value) || 0;
      const fl = Number(document.getElementById("flexLimit").value) || 0;
      settings.monthlyBudget = mb;
      settings.baseLimit = bl;
      settings.flexLimit = fl;
      saveSettings();
      render();
    }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateRu(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString("ru-RU");
    }

    function getPeriodFilteredExpenses() {
      const period = document.getElementById("period").value;
      const today = todayISO();

      if (period === "all") return expenses;

      if (period === "today") {
        return expenses.filter((e) => e.date === today);
      }

      if (period === "month") {
        const [y, m] = today.split("-");
        return expenses.filter((e) => {
          const [ey, em] = (e.date || "").split("-");
          return ey === y && em === m;
        });
      }

      return expenses;
    }

    function getCurrentMonthExpenseTotals() {
      const today = todayISO();
      const [y, m] = today.split("-");
      let sum = 0;
      let baseSum = 0;
      let flexSum = 0;

      expenses.forEach((e) => {
        const type = e.type || "expense";
        if (type !== "expense") return;

        const [ey, em] = (e.date || "").split("-");
        if (ey === y && em === m) {
          const amount = Number(e.amount) || 0;
          sum += amount;
          if (e.kind === "–ë–∞–∑–æ–≤—ã–µ") baseSum += amount;
          else if (e.kind === "–ì–∏–±–∫–∏–µ") flexSum += amount;
        }
      });

      return { sum, baseSum, flexSum };
    }

    function updateBudgetUI(barEl, infoEl) {
      const { sum, baseSum, flexSum } = getCurrentMonthExpenseTotals();
      const mb = settings.monthlyBudget || 0;
      const bl = settings.baseLimit || 0;
      const fl = settings.flexLimit || 0;
      const warnings = [];
      let text = "";

      if (mb > 0) {
        const percent = (sum / mb) * 100;
        const clamped = Math.min(percent, 100);
        barEl.style.width = `${clamped}%`;
        if (percent < 80) {
          barEl.style.background = "linear-gradient(90deg,#22c55e,#a3e635)";
        } else if (percent <= 100) {
          barEl.style.background = "linear-gradient(90deg,#eab308,#f97316)";
        } else {
          barEl.style.background = "linear-gradient(90deg,#ef4444,#b91c1c)";
        }

        if (sum <= mb) {
          const left = mb - sum;
          text = `–ó–∞ –º–µ—Å—è—Ü –ø–æ—Ç—Ä–∞—á–µ–Ω–æ ${sum.toLocaleString(
            "ru-RU"
          )} ‚ÇΩ –∏–∑ ${mb.toLocaleString(
            "ru-RU"
          )} ‚ÇΩ –±—é–¥–∂–µ—Ç–∞. –û—Å—Ç–∞–ª–æ—Å—å ~${left.toLocaleString("ru-RU")} ‚ÇΩ.`;
        } else {
          const over = sum - mb;
          text = `–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ –±—é–¥–∂–µ—Ç–∞: +${over.toLocaleString(
            "ru-RU"
          )} ‚ÇΩ —Å–≤–µ—Ä—Ö –ª–∏–º–∏—Ç–∞ (${sum.toLocaleString("ru-RU")} ‚ÇΩ —Ä–∞—Å—Ö–æ–¥–æ–≤).`;
          warnings.push(text);
        }
      } else {
        barEl.style.width = "0%";
        barEl.style.background = "linear-gradient(90deg,#22c55e,#a3e635)";
        text = "–ó–∞–¥–∞–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.";
      }

      if (bl > 0 && baseSum > bl) {
        warnings.push(
          `–ë–∞–∑–æ–≤—ã–µ —Ç—Ä–∞—Ç—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –ª–∏–º–∏—Ç: ${baseSum.toLocaleString(
            "ru-RU"
          )} ‚ÇΩ –∏–∑ ${bl.toLocaleString("ru-RU")} ‚ÇΩ.`
        );
      }

      if (fl > 0 && flexSum > fl) {
        warnings.push(
          `–ì–∏–±–∫–∏–µ —Ç—Ä–∞—Ç—ã (—Ö–æ—Ç–µ–ª–∫–∏) –ø—Ä–µ–≤—ã—à–∞—é—Ç –ª–∏–º–∏—Ç: ${flexSum.toLocaleString(
            "ru-RU"
          )} ‚ÇΩ –∏–∑ ${fl.toLocaleString("ru-RU")} ‚ÇΩ.`
        );
      }

      infoEl.textContent = text;
      return warnings;
    }

    function renderCategoryChart(byCategory, totalExpenses) {
      const chartEl = document.getElementById("chartCats");
      chartEl.innerHTML = "";

      const entries = Object.entries(byCategory);
      if (!entries.length) return;

      const maxVal = Math.max(...entries.map(([, v]) => v));

      entries
        .sort((a, b) => b[1] - a[1])
        .forEach(([cat, val]) => {
          const row = document.createElement("div");
          row.className = "chart-row";

          const label = document.createElement("div");
          label.className = "chart-label";
          label.textContent = cat;

          const wrap = document.createElement("div");
          wrap.className = "chart-bar-wrap";

          const barPair = document.createElement("div");
          barPair.className = "chart-bar-pair";

          const bar = document.createElement("div");
          bar.className = "chart-bar-income";
          const percent = maxVal ? (val / maxVal) * 100 : 0;
          requestAnimationFrame(() => {
            bar.style.width = `${percent}%`;
          });

          barPair.appendChild(bar);
          wrap.appendChild(barPair);

          const value = document.createElement("div");
          value.className = "chart-value";
          const share = totalExpenses ? (val / totalExpenses) * 100 : 0;
          value.textContent = `${val.toLocaleString("ru-RU")} ‚ÇΩ (${share.toFixed(
            0
          )}%)`;

          row.appendChild(label);
          row.appendChild(wrap);
          row.appendChild(value);
          chartEl.appendChild(row);
        });
    }

    function renderDayOverlapChart(byDateExp, byDateInc) {
      const chartEl = document.getElementById("chartDays");
      chartEl.innerHTML = "";

      const datesSet = new Set([
        ...Object.keys(byDateExp),
        ...Object.keys(byDateInc),
      ]);

      if (!datesSet.size) return;

      const dates = Array.from(datesSet).sort(
        (a, b) => new Date(a) - new Date(b)
      );

      let maxVal = 0;
      dates.forEach((d) => {
        const e = byDateExp[d] || 0;
        const i = byDateInc[d] || 0;
        maxVal = Math.max(maxVal, e, i);
      });

      dates.forEach((dateISO) => {
        const expVal = byDateExp[dateISO] || 0;
        const incVal = byDateInc[dateISO] || 0;

        const row = document.createElement("div");
        row.className = "chart-row";

        const label = document.createElement("div");
        label.className = "chart-label";
        label.textContent = formatDateRu(dateISO);

        const wrap = document.createElement("div");
        wrap.className = "chart-bar-wrap";

        const pair = document.createElement("div");
        pair.className = "chart-bar-pair";

        const barExp = document.createElement("div");
        barExp.className = "chart-bar-expense";

        const barInc = document.createElement("div");
        barInc.className = "chart-bar-income";

        const expPercent = maxVal ? (expVal / maxVal) * 100 : 0;
        const incPercent = maxVal ? (incVal / maxVal) * 100 : 0;

        requestAnimationFrame(() => {
          barExp.style.width = `${expPercent}%`;
          barInc.style.width = `${incPercent}%`;
        });

        pair.appendChild(barExp);
        pair.appendChild(barInc);
        wrap.appendChild(pair);

        const value = document.createElement("div");
        value.className = "chart-value";
        const balance = incVal - expVal;
        const sign = balance > 0 ? "+" : balance < 0 ? "‚Äì" : "";
        value.textContent =
          `–†: ${expVal.toLocaleString("ru-RU")} / –î: ${incVal.toLocaleString(
            "ru-RU"
          )} (${sign}${Math.abs(balance).toLocaleString("ru-RU")})`;

        row.appendChild(label);
        row.appendChild(wrap);
        row.appendChild(value);
        chartEl.appendChild(row);
      });
    }

    function render() {
      const listEl = document.getElementById("list");
      const totalEl = document.getElementById("totalAmount");
      const totalLabelEl = document.getElementById("totalLabel");
      const catsEl = document.getElementById("cats");
      const hintEl = document.getElementById("hint");
      const clearBtn = document.getElementById("clearBtn");
      const opsCountEl = document.getElementById("opsCount");
      const avgInfoEl = document.getElementById("avgInfo");
      const incomeInfoEl = document.getElementById("incomeInfo");
      const kindStatsEl = document.getElementById("kindStats");
      const budgetBar = document.getElementById("budgetBar");
      const budgetInfoEl = document.getElementById("budgetInfo");

      listEl.innerHTML = "";
      catsEl.innerHTML = "";
      hintEl.innerHTML = "";
      opsCountEl.textContent = "";
      avgInfoEl.textContent = "";
      incomeInfoEl.textContent = "";
      kindStatsEl.innerHTML = "";
      document.getElementById("chartCats").innerHTML = "";
      document.getElementById("chartDays").innerHTML = "";

      const budgetWarnings = updateBudgetUI(budgetBar, budgetInfoEl);

      const filtered = getPeriodFilteredExpenses();
      clearBtn.disabled = expenses.length === 0;

      if (filtered.length === 0) {
        listEl.innerHTML =
          '<div class="list-empty">–ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –æ –¥–æ—Ö–æ–¥–µ –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥–µ üëá</div>';
        totalEl.textContent = "0 ‚ÇΩ";
        totalLabelEl.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥";

        if (budgetWarnings.length) {
          hintEl.innerHTML = budgetWarnings.join("<br>");
        }
        hideSplash();
        return;
      }

      let totalExpenses = 0;
      let totalIncome = 0;
      let expenseCount = 0;
      let incomeCount = 0;

      const byCategory = {};
      const byKind = {};
      const byDateExp = {};
      const byDateInc = {};
      const daysSet = new Set();

      filtered.forEach((e) => {
        const id = e.id;
        const amount = Number(e.amount) || 0;
        const type = e.type || "expense";
        const kindKey = e.kind || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
        const dateStr = e.date || todayISO();

        if (type === "income") {
          totalIncome += amount;
          incomeCount += 1;

          if (!byDateInc[dateStr]) byDateInc[dateStr] = 0;
          byDateInc[dateStr] += amount;
        } else {
          totalExpenses += amount;
          expenseCount += 1;

          if (!byCategory[e.category]) byCategory[e.category] = 0;
          byCategory[e.category] += amount;

          if (!byKind[kindKey]) byKind[kindKey] = 0;
          byKind[kindKey] += amount;

          if (!byDateExp[dateStr]) byDateExp[dateStr] = 0;
          byDateExp[dateStr] += amount;

          daysSet.add(dateStr);
        }

        const item = document.createElement("div");
        item.className = "item";

        const main = document.createElement("div");
        main.className = "item-main";

        const line1 = document.createElement("div");
        line1.className = "item-line1";

        const amountSpan = document.createElement("span");
        amountSpan.className = "item-amount";
        amountSpan.textContent = `${amount} ‚ÇΩ`;
        if (type === "expense") amountSpan.classList.add("expense");

        const catSpan = document.createElement("span");
        catSpan.className = "item-cat";
        catSpan.textContent = e.category;

        const kindSpan = document.createElement("span");
        kindSpan.className = "item-kind";
        kindSpan.textContent =
          type === "expense" && e.kind ? `¬∑ ${e.kind}` : "";

        const typeTag = document.createElement("span");
        typeTag.className = "item-type-tag";
        typeTag.textContent = type === "income" ? "–î–æ—Ö–æ–¥" : "–†–∞—Å—Ö–æ–¥";

        const catKindWrapper = document.createElement("span");
        catKindWrapper.appendChild(catSpan);
        if (e.kind && type === "expense") catKindWrapper.appendChild(kindSpan);
        catKindWrapper.appendChild(typeTag);

        line1.appendChild(amountSpan);
        line1.appendChild(catKindWrapper);

        const desc = document.createElement("div");
        desc.className = "item-desc";
        desc.textContent = e.desc ? e.desc : "‚Äî";

        const date = document.createElement("div");
        date.className = "item-date";
        date.textContent = formatDateRu(dateStr);

        main.appendChild(line1);
        main.appendChild(desc);
        main.appendChild(date);

        const delBtn = document.createElement("button");
        delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        delBtn.onclick = function () {
          if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
            expenses = expenses.filter((x) => x.id !== id);
            saveExpenses();
            render();
          }
        };

        item.appendChild(main);
        item.appendChild(delBtn);
        listEl.appendChild(item);
      });

      totalEl.textContent = `${totalExpenses.toLocaleString("ru-RU")} ‚ÇΩ`;

      const periodName = {
        all: "–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
        today: "–∑–∞ —Å–µ–≥–æ–¥–Ω—è",
        month: "–∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü",
      }[document.getElementById("period").value];

      totalLabelEl.textContent = `–†–∞—Å—Ö–æ–¥—ã ${periodName}`;
      const totalOps = filtered.length;
      opsCountEl.textContent = `–û–ø–µ—Ä–∞—Ü–∏–π: ${totalOps} (—Ä–∞—Å—Ö–æ–¥—ã: ${expenseCount}, –¥–æ—Ö–æ–¥—ã: ${incomeCount})`;

      const daysCount = Math.max(daysSet.size, 1);
      const avgPerDay = totalExpenses / daysCount;
      avgInfoEl.textContent = `–°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã ~${Math.round(
        avgPerDay
      ).toLocaleString("ru-RU")} ‚ÇΩ –≤ –¥–µ–Ω—å (–¥–Ω–µ–π —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏: ${daysCount})`;

      const balance = totalIncome - totalExpenses;
      incomeInfoEl.textContent = `–î–æ—Ö–æ–¥—ã: ${totalIncome.toLocaleString(
        "ru-RU"
      )} ‚ÇΩ, –±–∞–ª–∞–Ω—Å –∑–∞ –ø–µ—Ä–∏–æ–¥: ${balance.toLocaleString("ru-RU")} ‚ÇΩ`;

      Object.keys(byCategory).forEach((cat) => {
        const row = document.createElement("div");
        const left = document.createElement("span");
        const right = document.createElement("span");

        left.textContent = cat;
        right.textContent = `${byCategory[cat].toLocaleString("ru-RU")} ‚ÇΩ`;

        row.appendChild(left);
        row.appendChild(right);
        catsEl.appendChild(row);
      });

      if (Object.keys(byKind).length) {
        Object.entries(byKind).forEach(([k, v]) => {
          const row = document.createElement("div");
          const left = document.createElement("span");
          const right = document.createElement("span");

          const share = totalExpenses ? (v / totalExpenses) * 100 : 0;

          left.textContent = k;
          right.textContent = `${v.toLocaleString("ru-RU")} ‚ÇΩ (${share.toFixed(
            1
          )}%)`;

          row.appendChild(left);
          row.appendChild(right);
          kindStatsEl.appendChild(row);
        });
      }

      let hintParts = [];

      let maxCat = null;
      let maxVal = 0;
      Object.entries(byCategory).forEach(([cat, val]) => {
        if (val > maxVal) {
          maxVal = val;
          maxCat = cat;
        }
      });

      if (maxCat && totalExpenses > 0) {
        const share = ((maxVal / totalExpenses) * 100).toFixed(1);
        if (share > 40) {
          hintParts.push(
            `–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ç—ã —Ç—Ä–∞—Ç–∏—à—å –Ω–∞ ¬´${maxCat}¬ª ‚Äî ${maxVal.toLocaleString(
              "ru-RU"
            )} ‚ÇΩ (${share}% –æ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥).`
          );
        } else {
          hintParts.push(
            `–ë–∞–ª–∞–Ω—Å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–ø–ª–æ—Ö–æ: ¬´${maxCat}¬ª ‚Äî —Å–∞–º–∞—è –∫—Ä—É–ø–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (${share}% —Ä–∞—Å—Ö–æ–¥–æ–≤).`
          );
        }
      }

      if (budgetWarnings.length) {
        hintParts = hintParts.concat(budgetWarnings);
      }

      if (hintParts.length) {
        hintEl.innerHTML = hintParts.join("<br>");
      }

      renderCategoryChart(byCategory, totalExpenses);
      renderDayOverlapChart(byDateExp, byDateInc);

      hideSplash();
    }

    function autoKindByCategory() {
      const cat = document.getElementById("categoryExp").value;
      const kindSelect = document.getElementById("kindExp");
      const essential = ["–ü—Ä–æ–¥—É–∫—Ç—ã", "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ê–≤—Ç–æ", "–°–≤—è–∑—å/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–î–æ–º/–±—ã—Ç"];
      kindSelect.value = essential.includes(cat) ? "–ë–∞–∑–æ–≤—ã–µ" : "–ì–∏–±–∫–∏–µ";
    }

    function addExpense() {
      const amountInput = document.getElementById("amountExp");
      const dateInput = document.getElementById("dateExp");
      const categoryInput = document.getElementById("categoryExp");
      const kindInput = document.getElementById("kindExp");
      const descInput = document.getElementById("descExp");

      const amount = Number(amountInput.value);
      const date = dateInput.value || todayISO();
      const category = categoryInput.value;
      const kind = kindInput.value || "–ë–∞–∑–æ–≤—ã–µ";
      const desc = descInput.value.trim();

      if (!amount || amount <= 0) {
        alert("–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞");
        return;
      }

      const exp = {
        id: Date.now() + Math.random().toString(16).slice(2),
        amount,
        date,
        category,
        kind,
        type: "expense",
        desc,
      };

      expenses.push(exp);
      saveExpenses();
      render();

      amountInput.value = "";
      descInput.value = "";
    }

    function addIncome() {
      const amountInput = document.getElementById("amountInc");
      const dateInput = document.getElementById("dateInc");
      const categoryInput = document.getElementById("categoryInc");
      const descInput = document.getElementById("descInc");

      const amount = Number(amountInput.value);
      const date = dateInput.value || todayISO();
      const category = categoryInput.value;
      const desc = descInput.value.trim();

      if (!amount || amount <= 0) {
        alert("–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞");
        return;
      }

      const inc = {
        id: Date.now() + Math.random().toString(16).slice(2),
        amount,
        date,
        category,
        kind: "–î–æ—Ö–æ–¥",
        type: "income",
        desc,
      };

      expenses.push(inc);
      saveExpenses();
      render();

      amountInput.value = "";
      descInput.value = "";
    }

    function clearAll() {
      if (!expenses.length) return;
      if (confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏?")) {
        expenses = [];
        saveExpenses();
        render();
      }
    }

    // üîÆ —Å–∫—Ä—ã—Ç—å splash –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏/—Ä–µ–Ω–¥–µ—Ä–∞
    function hideSplash() {
      const splash = document.getElementById("splash");
      if (!splash) return;
      // —á—É—Ç—å –ø–æ–¥–µ—Ä–∂–∏–º, —á—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ–ª–∞ ¬´—Å—ã–≥—Ä–∞—Ç—å¬ª
      setTimeout(() => {
        splash.classList.add("splash-hidden");
        setTimeout(() => {
          if (splash && splash.parentNode) {
            splash.parentNode.removeChild(splash);
          }
        }, 800);
      }, 400);
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker –¥–ª—è PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .catch((err) => console.log("SW registration failed", err));
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadExpenses();
    loadSettings();
    document.getElementById("dateExp").value = todayISO();
    document.getElementById("dateInc").value = todayISO();
    autoKindByCategory();
    syncSettingsToUI();
    render();
  </script>
</body>
</html>
