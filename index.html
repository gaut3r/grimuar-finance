<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ì—Ä–∏–º—É–∞—Ä –§–∏–Ω–∞–Ω—Å–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(15,23,42,0.95) 40%, #020617 80%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    /* –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ç—É–º–∞–Ω */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(244, 114, 182, 0.18), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(129, 140, 248, 0.18), transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.8;
      z-index: -1;
      animation: floatGlow 18s ease-in-out infinite alternate;
    }

    @keyframes floatGlow {
      from { transform: translate3d(0, 0, 0); }
      to   { transform: translate3d(0, -20px, 0); }
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    header {
      text-align: center;
      padding: 8px 0 4px;
    }

    header h1 {
      font-family: "Playfair Display", system-ui, serif;
      font-size: 24px;
      letter-spacing: 0.05em;
      margin: 0;
      color: #e5e7ff;
      text-shadow: 0 0 8px rgba(167, 139, 250, 0.6);
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: #a5b4fc;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(76,29,149,0.35), rgba(15,23,42,0.95));
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow:
        0 18px 35px rgba(15,23,42,0.8),
        0 0 0 1px rgba(148,163,184,0.18);
      border: 1px solid rgba(129, 140, 248, 0.35);
      backdrop-filter: blur(14px);
    }

    .card.accent-income {
      border-color: rgba(45,212,191,0.7);
      background: radial-gradient(circle at top right, rgba(21,128,61,0.28), rgba(15,23,42,0.96));
    }

    .card.accent-expense {
      border-color: rgba(248,113,113,0.7);
      background: radial-gradient(circle at top left, rgba(147,51,234,0.3), rgba(15,23,42,0.96));
    }

    .card-title {
      font-size: 13px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #c4b5fd;
    }

    .card-title span {
      font-family: "Playfair Display", serif;
      font-weight: 600;
    }

    label {
      font-size: 12px;
      display: block;
      margin-bottom: 4px;
      color: #c7d2fe;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 8px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }

    input::placeholder {
      color: #6b7280;
    }

    input:focus, select:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 1px rgba(168,85,247,0.7);
    }

    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 4px;
      font-family: "Inter", system-ui, sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #a855f7, #22c55e);
      color: #020617;
      box-shadow: 0 10px 25px rgba(148,163,184,0.35);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.92);
      color: #e5e7eb;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .btn-secondary:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary:hover { filter: brightness(1.05); }
    .btn-secondary:hover:not(:disabled) { background: rgba(30,64,175,0.8); }

    .top-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 8px;
    }

    .filters-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .filters-row select {
      margin-bottom: 0;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 999px;
    }

    .filters-row span {
      font-size: 12px;
      color: #c7d2fe;
    }

    .stats-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .stats-total {
      font-size: 19px;
      font-weight: 600;
      background: linear-gradient(120deg,#bfdbfe,#c4b5fd);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .stats-sub {
      font-size: 12px;
      color: #9ca3af;
    }

    .cats {
      font-size: 13px;
      margin-top: 4px;
    }

    .cats div {
      display: flex;
      justify-content: space-between;
    }

    .kind-stats {
      font-size: 12px;
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      color: #e5e7eb;
    }

    .kind-stats div {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }

    .hint {
      margin-top: 6px;
      font-size: 12px;
      color: #e0e7ff;
    }

    .list-empty {
      font-size: 13px;
      color: #9ca3af;
    }

    .badge-budget {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(30,64,175,0.7);
      color: #e0f2fe;
      margin-bottom: 6px;
    }

    .badge-budget span {
      font-size: 13px;
    }

    .item {
      display: flex;
      gap: 8px;
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.55);
      align-items: center;
      animation: fadeInUp 0.18s ease-out;
    }

    .item-main { flex: 1; }

    .item-line1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      gap: 10px;
    }

    .item-amount {
      font-weight: 600;
      color: #22c55e;
      white-space: nowrap;
    }

    .item-amount.expense { color: #f97373; }

    .item-cat {
      font-size: 12px;
      color: #c7d2fe;
    }

    .item-kind {
      font-size: 11px;
      color: #fde68a;
      margin-left: 4px;
    }

    .item-type-tag {
      font-size: 11px;
      color: #a5b4fc;
      margin-left: 6px;
    }

    .item-desc {
      font-size: 12px;
      margin-top: 2px;
      color: #e5e7eb;
      word-break: break-word;
    }

    .item-date {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .item button {
      width: auto;
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(127,29,29,0.9);
      color: #fee2e2;
      border: 1px solid rgba(248,113,113,0.7);
    }

    .item button:hover { filter: brightness(1.05); }

    .chart { margin-top: 6px; }

    .chart-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .chart-label {
      width: 90px;
      color: #c7d2fe;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chart-bar-wrap {
      flex: 1;
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #1f2937;
      padding: 2px 3px;
    }

    .chart-value {
      width: 120px;
      text-align: right;
      font-size: 11px;
      color: #e5e7eb;
      white-space: nowrap;
    }

    .chart-title {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      margin-bottom: 2px;
      font-style: italic;
    }

    .budget-progress-wrap {
      margin-top: 6px;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .budget-progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.35s ease-out, background 0.25s ease-out;
    }

    /* –î–ª—è overlap-–≥—Ä–∞—Ñ–∏–∫–∞ –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ */
    .chart-bar-pair {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chart-bar-expense,
    .chart-bar-income {
      height: 6px;
      border-radius: 999px;
      width: 0;
      transition: width 0.35s ease-out;
    }

    .chart-bar-expense { background: linear-gradient(90deg, #f97373, #ef4444); }
    .chart-bar-income  { background: linear-gradient(90deg, #22c55e, #0ea5e9); }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 360px) {
      .top-row { grid-template-columns: 1fr; }
    }

    /* üîÆ Splash-—ç–∫—Ä–∞–Ω */
    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at top, #4c1d95 0, rgba(15,23,42,0.98) 40%, #020617 80%);
      z-index: 999;
      overflow: hidden;
      transition: opacity 0.7s ease-out;
    }

    .splash-hidden { opacity: 0; pointer-events: none; }

    .splash-orb {
      width: 120px;
      height: 120px;
      border-radius: 999px;
      border: 2px solid rgba(196,181,253,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow:
        0 0 25px rgba(129, 140, 248, 0.7),
        0 0 60px rgba(56, 189, 248, 0.4);
      animation: orbPulse 2.3s ease-in-out infinite;
    }

    .splash-orb::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: inherit;
      border: 1px dashed rgba(165,180,252,0.8);
      animation: orbSpin 9s linear infinite;
      opacity: 0.8;
    }

    .splash-orb-inner {
      width: 70px;
      height: 70px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #facc15, #f97316 40%, #4c1d95 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #020617;
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: 32px;
      text-shadow: 0 0 8px rgba(253,224,71,0.7);
    }

    .splash-title {
      margin-top: 16px;
      font-family: "Playfair Display", serif;
      font-size: 22px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7ff;
      text-shadow: 0 0 8px rgba(129,140,248,0.7);
      text-align: center;
    }

    .splash-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: #c7d2fe;
      opacity: 0.9;
      text-align: center;
    }

    .splash-hint {
      position: absolute;
      bottom: 28px;
      font-size: 11px;
      color: #9ca3af;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-align: center;
      padding: 0 16px;
    }

    @keyframes orbPulse {
      0%   { transform: scale(1); box-shadow: 0 0 20px rgba(129, 140, 248, 0.6); }
      50%  { transform: scale(1.06); box-shadow: 0 0 35px rgba(129, 140, 248, 0.9); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(129, 140, 248, 0.6); }
    }

    @keyframes orbSpin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    /* --- –ú–æ—â–Ω—ã–µ —Ñ–∏—á–∏: —Ü–µ–ª–∏ + –±—ç–∫–∞–ø + –∏–Ω—Å–∞–π—Ç—ã --- */
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    @media (max-width: 420px) {
      .row { grid-template-columns: 1fr; }
    }

    .goal {
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.55);
      border-radius: 14px;
      padding: 10px;
      margin-top: 8px;
    }

    .goal-title {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      font-size: 14px;
    }

    .goal-title b {
      font-family: "Playfair Display", serif;
      font-weight: 700;
      color: #e5e7ff;
    }

    .goal-sub {
      margin-top: 4px;
      font-size: 12px;
      color: #c7d2fe;
    }

    .goal-bar {
      margin-top: 8px;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(2,6,23,0.65);
      border: 1px solid rgba(148,163,184,0.35);
    }

    .goal-bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #a855f7, #22c55e);
      transition: width 0.35s ease-out;
    }

    .goal-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .goal-actions input {
      margin-bottom: 0;
      border-radius: 999px;
      flex: 1;
      min-width: 160px;
    }

    .goal-actions button {
      width: auto;
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 999px;
      margin-top: 0;
    }

    .inline-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }

    .inline-actions button {
      width: auto;
      padding: 8px 10px;
      font-size: 12px;
      margin-top: 0;
    }

    .file-input {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px dashed rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
    }

    .kbd {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(15,23,42,0.7);
      font-size: 11px;
      color: #c7d2fe;
    }

    .insight {
      margin-top: 8px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.55);
      font-size: 13px;
      color: #e5e7eb;
      line-height: 1.4;
    }

    .insight small {
      display: block;
      margin-top: 6px;
      color: #9ca3af;
      font-size: 12px;
    }

    /* --- –ü–æ–∏—Å–∫ / —Ñ–∏–ª—å—Ç—Ä—ã / —á–∏–ø—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π --- */
    .searchbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .searchbar input {
      margin-bottom: 0;
      border-radius: 999px;
    }

    .searchbar select {
      margin-bottom: 0;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .chip {
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: transform 0.08s ease;
      user-select: none;
    }

    .chip:active { transform: scale(0.98); }

    .chip.active {
      border-color: rgba(168,85,247,0.85);
      box-shadow: 0 0 0 1px rgba(168,85,247,0.55);
    }

    .small-btn {
      width: auto !important;
      padding: 8px 10px !important;
      border-radius: 999px !important;
      font-size: 12px !important;
      margin-top: 0 !important;
    }
  </style>
</head>

<body>
  <!-- Splash -->
  <div id="splash" class="splash">
    <div class="splash-orb">
      <div class="splash-orb-inner">G</div>
    </div>
    <div class="splash-title">–ì—Ä–∏–º—É–∞—Ä –§–∏–Ω–∞–Ω—Å–æ–≤</div>
    <div class="splash-subtitle">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ –º–∞–≥–∏–∏ –¥–µ–Ω–µ–≥...</div>
    <div class="splash-hint">–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–≤–∏—Ç–∫–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü</div>
  </div>

  <div class="app">
    <header>
      <h1>–õ–∏—á–Ω—ã–π –≥—Ä–∏–º—É–∞—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤</h1>
      <p>–ó–∞–ø–∏—Å–∏ –æ –¥–æ—Ö–æ–¥–∞—Ö –∏ —Ç—Ä–∞—Ç–∞—Ö, –Ω–µ–º–Ω–æ–≥–æ –º–∞–≥–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚ú®</p>
    </header>

    <!-- –ë—é–¥–∂–µ—Ç -->
    <section class="card">
      <div class="card-title"><span>–ë—é–¥–∂–µ—Ç –º–µ—Å—è—Ü–∞</span></div>

      <div class="badge-budget">
        ‚ú® <span>–ù–∞—Å—Ç—Ä–æ–π –ª–∏–º–∏—Ç—ã –∏ –Ω–∞–±–ª—é–¥–∞–π –∑–∞ –º–∞–≥–∏–µ–π —Ü–∏—Ñ—Ä</span>
      </div>

      <label for="monthlyBudget">–ë—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü (‚ÇΩ)</label>
      <input id="monthlyBudget" type="number" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 60000" oninput="updateSettingsFromUI()" />

      <label for="baseLimit">–õ–∏–º–∏—Ç –±–∞–∑–æ–≤—ã—Ö —Ç—Ä–∞—Ç (‚ÇΩ)</label>
      <input id="baseLimit" type="number" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 40000" oninput="updateSettingsFromUI()" />

      <label for="flexLimit">–õ–∏–º–∏—Ç –≥–∏–±–∫–∏—Ö —Ç—Ä–∞—Ç (‚ÇΩ)</label>
      <input id="flexLimit" type="number" min="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15000" oninput="updateSettingsFromUI()" />

      <div class="budget-progress-wrap">
        <div class="budget-progress-bar" id="budgetBar"></div>
      </div>
      <div class="stats-sub" id="budgetInfo"></div>
    </section>

    <!-- –ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥ -->
    <section class="card accent-expense">
      <div class="card-title"><span>–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</span></div>

      <div class="top-row">
        <div>
          <label for="amountExp">–°—É–º–º–∞ (‚ÇΩ)</label>
          <input id="amountExp" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 750" />
        </div>
        <div>
          <label for="dateExp">–î–∞—Ç–∞</label>
          <input id="dateExp" type="date" />
        </div>
      </div>

      <label for="categoryExp">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <div class="searchbar" style="margin-top:0;">
        <select id="categoryExp" onchange="autoKindByCategory()">
          <option>–ü—Ä–æ–¥—É–∫—Ç—ã</option>
          <option>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
          <option>–ê–≤—Ç–æ</option>
          <option>–û–¥–µ–∂–¥–∞</option>
          <option>–ö–∞—Ñ–µ</option>
          <option>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
          <option>–°–≤—è–∑—å/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç</option>
          <option>–î–æ–º/–±—ã—Ç</option>
          <option>–î—Ä—É–≥–æ–µ</option>
        </select>
        <button class="btn-secondary small-btn" onclick="toggleFavoriteCategory()">‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
      </div>

      <label for="kindExp">–¢–∏–ø —Ç—Ä–∞—Ç—ã</label>
      <select id="kindExp">
        <option value="–ë–∞–∑–æ–≤—ã–µ">–ë–∞–∑–æ–≤—ã–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)</option>
        <option value="–ì–∏–±–∫–∏–µ">–ì–∏–±–∫–∏–µ (—Ö–æ—Ç–µ–ª–∫–∏)</option>
      </select>

      <label for="descExp">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input id="descExp" type="text" placeholder="–ú–∞–≥–Ω–∏—Ç, –∑–∞–ø—Ä–∞–≤–∫–∞, –æ–¥–µ–∂–¥–∞..." />

      <button class="btn-primary" onclick="addExpense()">–ó–∞–ø–∏—Å–∞—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
    </section>

    <!-- –ù–æ–≤—ã–π –¥–æ—Ö–æ–¥ -->
    <section class="card accent-income">
      <div class="card-title"><span>–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥</span></div>

      <div class="top-row">
        <div>
          <label for="amountInc">–°—É–º–º–∞ (‚ÇΩ)</label>
          <input id="amountInc" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50000" />
        </div>
        <div>
          <label for="dateInc">–î–∞—Ç–∞</label>
          <input id="dateInc" type="date" />
        </div>
      </div>

      <label for="categoryInc">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞</label>
      <select id="categoryInc">
        <option>–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
        <option>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</option>
        <option>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</option>
        <option>–ü–æ–¥–∞—Ä–æ–∫</option>
        <option>–î—Ä—É–≥–æ–µ</option>
      </select>

      <label for="descInc">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input id="descInc" type="text" placeholder="–ó–∞—Ä–ø–ª–∞—Ç–∞, —Ñ—Ä–∏–ª–∞–Ω—Å, –∫–µ—à–±—ç–∫..." />

      <button class="btn-primary" onclick="addIncome()">–ó–∞–ø–∏—Å–∞—Ç—å –¥–æ—Ö–æ–¥</button>
      <button class="btn-secondary" onclick="clearAll()" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
    </section>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <section class="card">
      <div class="card-title"><span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></div>

      <div class="filters-row">
        <span>–ü–µ—Ä–∏–æ–¥:</span>
        <select id="period" onchange="render()">
          <option value="month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
      </div>

      <div class="stats-main">
        <div>
          <div class="stats-total" id="totalAmount">0 ‚ÇΩ</div>
          <div class="stats-sub" id="totalLabel">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        </div>
      </div>

      <div class="stats-sub" id="opsCount"></div>
      <div class="stats-sub" id="avgInfo"></div>
      <div class="stats-sub" id="incomeInfo"></div>

      <div class="cats" id="cats"></div>
      <div class="kind-stats" id="kindStats"></div>

      <div class="chart-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
      <div class="chart" id="chartCats"></div>

      <div class="chart-title">–î–æ—Ö–æ–¥—ã vs —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–Ω—è–º</div>
      <div class="chart" id="chartDays"></div>

      <div class="hint" id="hint"></div>
    </section>

    <!-- –¶–µ–ª–∏ -->
    <section class="card">
      <div class="card-title"><span>–¶–µ–ª–∏ –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</span></div>

      <div class="row">
        <div>
          <label for="goalName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
          <input id="goalName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥—É—à–∫–∞, –û—Ç–ø—É—Å–∫, –ù–æ—É—Ç–±—É–∫" />
        </div>
        <div>
          <label for="goalTarget">–°—É–º–º–∞ —Ü–µ–ª–∏ (‚ÇΩ)</label>
          <input id="goalTarget" type="number" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100000" />
        </div>
      </div>

      <div class="inline-actions">
        <button class="btn-primary" onclick="addGoal()">–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å</button>
        <button class="btn-secondary" onclick="clearGoals()" id="clearGoalsBtn">–û—á–∏—Å—Ç–∏—Ç—å —Ü–µ–ª–∏</button>
      </div>

      <div class="hint">–°–æ–≤–µ—Ç: —Ü–µ–ª—å + —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ = –º–∞–≥–∏—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã ‚ú®</div>
      <div id="goalsList"></div>
    </section>

    <!-- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è -->
    <section class="card">
      <div class="card-title"><span>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</span></div>

      <div class="inline-actions">
        <button class="btn-primary" onclick="exportJSON()">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button class="btn-secondary" onclick="exportCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>

      <div class="hint">
        –ò–º–ø–æ—Ä—Ç JSON: –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª. –ú–æ–∂–Ω–æ <span class="kbd">–¥–æ–±–∞–≤–∏—Ç—å</span> –∫ —Ç–µ–∫—É—â–∏–º –¥–∞–Ω–Ω—ã–º –∏–ª–∏ <span class="kbd">–∑–∞–º–µ–Ω–∏—Ç—å</span>.
      </div>

      <div class="inline-actions">
        <label style="display:flex; gap:8px; align-items:center; font-size:12px; color:#c7d2fe;">
          <input type="checkbox" id="importMerge" checked />
          –î–æ–±–∞–≤–∏—Ç—å –∫ —Ç–µ–∫—É—â–∏–º (merge)
        </label>
      </div>

      <input class="file-input" id="importFile" type="file" accept="application/json" onchange="importJSONFile(event)" />
    </section>

    <!-- –ò–Ω—Å–∞–π—Ç—ã -->
    <section class="card">
      <div class="card-title"><span>–ò–Ω—Å–∞–π—Ç—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑</span></div>
      <div id="insightsBox" class="insight">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.</div>
    </section>

    <!-- –õ–µ–Ω—Ç–∞ -->
    <section class="card" style="margin-bottom: 12px;">
      <div class="card-title"><span>–õ–µ–Ω—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π</span></div>

      <div class="searchbar">
        <input id="q" type="text" placeholder="–ü–æ–∏—Å–∫: –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–∏–ø..." oninput="onFiltersChanged()" />
        <select id="fType" onchange="onFiltersChanged()">
          <option value="all">–í—Å–µ</option>
          <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
          <option value="income">–î–æ—Ö–æ–¥—ã</option>
        </select>
        <select id="fCat" onchange="onFiltersChanged()">
          <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        </select>
        <select id="fSort" onchange="onFiltersChanged()">
          <option value="date_desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
          <option value="date_asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
          <option value="amount_desc">–°—É–º–º–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
          <option value="amount_asc">–°—É–º–º–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        </select>
        <button class="btn-secondary small-btn" onclick="resetFilters()">–°–±—Ä–æ—Å</button>
      </div>

      <div class="hint">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –Ω–∞–∂–º–∏ ‚Äî –∏ –±—ã—Å—Ç—Ä–æ –ø–æ–¥—Å—Ç–∞–≤–∏–º –≤ ‚Äú–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥‚Äù.</div>
      <div id="favChips" class="chips"></div>

      <div id="list" style="margin-top:8px;"></div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "expenses-v4";
    const SETTINGS_KEY = "expenses-settings-v1";
    const GOALS_KEY = "grimuar-goals-v1";
    const FAVORITES_KEY = "grimuar-favorites-v1";

    let expenses = [];
    let settings = { monthlyBudget: 0, baseLimit: 0, flexLimit: 0 };
    let goals = [];
    let favoriteCategories = [];

    const uiFilters = {
      q: "",
      type: "all",
      cat: "all",
      sort: "date_desc",
    };

    // ---------- storage ----------
    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        expenses = raw ? JSON.parse(raw) : [];
      } catch (e) {
        expenses = [];
      }
    }

    function saveExpenses() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
    }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        settings = raw
          ? JSON.parse(raw)
          : { monthlyBudget: 0, baseLimit: 0, flexLimit: 0 };
      } catch (e) {
        settings = { monthlyBudget: 0, baseLimit: 0, flexLimit: 0 };
      }
    }

    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function syncSettingsToUI() {
      document.getElementById("monthlyBudget").value = settings.monthlyBudget || "";
      document.getElementById("baseLimit").value = settings.baseLimit || "";
      document.getElementById("flexLimit").value = settings.flexLimit || "";
    }

    function updateSettingsFromUI() {
      const mb = Number(document.getElementById("monthlyBudget").value) || 0;
      const bl = Number(document.getElementById("baseLimit").value) || 0;
      const fl = Number(document.getElementById("flexLimit").value) || 0;
      settings.monthlyBudget = mb;
      settings.baseLimit = bl;
      settings.flexLimit = fl;
      saveSettings();
      render();
    }

    function loadGoals() {
      try {
        const raw = localStorage.getItem(GOALS_KEY);
        goals = raw ? JSON.parse(raw) : [];
      } catch (e) {
        goals = [];
      }
    }

    function saveGoals() {
      localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
    }

    function loadFavorites() {
      try {
        const raw = localStorage.getItem(FAVORITES_KEY);
        favoriteCategories = raw ? JSON.parse(raw) : [];
      } catch (e) {
        favoriteCategories = [];
      }
    }

    function saveFavorites() {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favoriteCategories));
    }

    // ---------- utils ----------
    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateRu(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString("ru-RU");
    }

    function escapeHTML(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function csvSafe(s) {
      const t = String(s ?? "");
      const needsQuotes = t.includes(",") || t.includes("\n") || t.includes('"');
      const escaped = t.replaceAll('"', '""');
      return needsQuotes ? `"${escaped}"` : escaped;
    }

    // ---------- period ----------
    function getPeriodFilteredExpenses() {
      const period = document.getElementById("period").value;
      const today = todayISO();

      if (period === "all") return expenses;

      if (period === "today") {
        return expenses.filter((e) => e.date === today);
      }

      if (period === "month") {
        const [y, m] = today.split("-");
        return expenses.filter((e) => {
          const [ey, em] = (e.date || "").split("-");
          return ey === y && em === m;
        });
      }

      return expenses;
    }

    // ---------- budget ----------
    function getCurrentMonthExpenseTotals() {
      const today = todayISO();
      const [y, m] = today.split("-");
      let sum = 0;
      let baseSum = 0;
      let flexSum = 0;

      expenses.forEach((e) => {
        const type = e.type || "expense";
        if (type !== "expense") return;

        const [ey, em] = (e.date || "").split("-");
        if (ey === y && em === m) {
          const amount = Number(e.amount) || 0;
          sum += amount;
          if (e.kind === "–ë–∞–∑–æ–≤—ã–µ") baseSum += amount;
          else if (e.kind === "–ì–∏–±–∫–∏–µ") flexSum += amount;
        }
      });

      return { sum, baseSum, flexSum };
    }

    function updateBudgetUI(barEl, infoEl) {
      const { sum, baseSum, flexSum } = getCurrentMonthExpenseTotals();
      const mb = settings.monthlyBudget || 0;
      const bl = settings.baseLimit || 0;
      const fl = settings.flexLimit || 0;
      const warnings = [];
      let text = "";

      if (mb > 0) {
        const percent = (sum / mb) * 100;
        const clamped = Math.min(percent, 100);
        barEl.style.width = `${clamped}%`;

        if (percent < 80) barEl.style.background = "linear-gradient(90deg,#22c55e,#a3e635)";
        else if (percent <= 100) barEl.style.background = "linear-gradient(90deg,#eab308,#f97316)";
        else barEl.style.background = "linear-gradient(90deg,#ef4444,#b91c1c)";

        if (sum <= mb) {
          const left = mb - sum;
          text = `–ó–∞ –º–µ—Å—è—Ü –ø–æ—Ç—Ä–∞—á–µ–Ω–æ ${sum.toLocaleString("ru-RU")} ‚ÇΩ –∏–∑ ${mb.toLocaleString("ru-RU")} ‚ÇΩ –±—é–¥–∂–µ—Ç–∞. –û—Å—Ç–∞–ª–æ—Å—å ~${left.toLocaleString("ru-RU")} ‚ÇΩ.`;
        } else {
          const over = sum - mb;
          text = `–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ –±—é–¥–∂–µ—Ç–∞: +${over.toLocaleString("ru-RU")} ‚ÇΩ —Å–≤–µ—Ä—Ö –ª–∏–º–∏—Ç–∞ (${sum.toLocaleString("ru-RU")} ‚ÇΩ —Ä–∞—Å—Ö–æ–¥–æ–≤).`;
          warnings.push(text);
        }
      } else {
        barEl.style.width = "0%";
        barEl.style.background = "linear-gradient(90deg,#22c55e,#a3e635)";
        text = "–ó–∞–¥–∞–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–µ—Å—è—Ü, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.";
      }

      if (bl > 0 && baseSum > bl) {
        warnings.push(`–ë–∞–∑–æ–≤—ã–µ —Ç—Ä–∞—Ç—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –ª–∏–º–∏—Ç: ${baseSum.toLocaleString("ru-RU")} ‚ÇΩ –∏–∑ ${bl.toLocaleString("ru-RU")} ‚ÇΩ.`);
      }
      if (fl > 0 && flexSum > fl) {
        warnings.push(`–ì–∏–±–∫–∏–µ —Ç—Ä–∞—Ç—ã (—Ö–æ—Ç–µ–ª–∫–∏) –ø—Ä–µ–≤—ã—à–∞—é—Ç –ª–∏–º–∏—Ç: ${flexSum.toLocaleString("ru-RU")} ‚ÇΩ –∏–∑ ${fl.toLocaleString("ru-RU")} ‚ÇΩ.`);
      }

      infoEl.textContent = text;
      return warnings;
    }

    // ---------- charts ----------
    function renderCategoryChart(byCategory, totalExpenses) {
      const chartEl = document.getElementById("chartCats");
      chartEl.innerHTML = "";

      const entries = Object.entries(byCategory);
      if (!entries.length) return;

      const maxVal = Math.max(...entries.map(([, v]) => v));

      entries
        .sort((a, b) => b[1] - a[1])
        .forEach(([cat, val]) => {
          const row = document.createElement("div");
          row.className = "chart-row";

          const label = document.createElement("div");
          label.className = "chart-label";
          label.textContent = cat;

          const wrap = document.createElement("div");
          wrap.className = "chart-bar-wrap";

          const barPair = document.createElement("div");
          barPair.className = "chart-bar-pair";

          const bar = document.createElement("div");
          bar.className = "chart-bar-income";
          const percent = maxVal ? (val / maxVal) * 100 : 0;
          requestAnimationFrame(() => {
            bar.style.width = `${percent}%`;
          });

          barPair.appendChild(bar);
          wrap.appendChild(barPair);

          const value = document.createElement("div");
          value.className = "chart-value";
          const share = totalExpenses ? (val / totalExpenses) * 100 : 0;
          value.textContent = `${val.toLocaleString("ru-RU")} ‚ÇΩ (${share.toFixed(0)}%)`;

          row.appendChild(label);
          row.appendChild(wrap);
          row.appendChild(value);
          chartEl.appendChild(row);
        });
    }

    function renderDayOverlapChart(byDateExp, byDateInc) {
      const chartEl = document.getElementById("chartDays");
      chartEl.innerHTML = "";

      const datesSet = new Set([...Object.keys(byDateExp), ...Object.keys(byDateInc)]);
      if (!datesSet.size) return;

      const dates = Array.from(datesSet).sort((a, b) => new Date(a) - new Date(b));

      let maxVal = 0;
      dates.forEach((d) => {
        maxVal = Math.max(maxVal, byDateExp[d] || 0, byDateInc[d] || 0);
      });

      dates.forEach((dateISO) => {
        const expVal = byDateExp[dateISO] || 0;
        const incVal = byDateInc[dateISO] || 0;

        const row = document.createElement("div");
        row.className = "chart-row";

        const label = document.createElement("div");
        label.className = "chart-label";
        label.textContent = formatDateRu(dateISO);

        const wrap = document.createElement("div");
        wrap.className = "chart-bar-wrap";

        const pair = document.createElement("div");
        pair.className = "chart-bar-pair";

        const barExp = document.createElement("div");
        barExp.className = "chart-bar-expense";

        const barInc = document.createElement("div");
        barInc.className = "chart-bar-income";

        const expPercent = maxVal ? (expVal / maxVal) * 100 : 0;
        const incPercent = maxVal ? (incVal / maxVal) * 100 : 0;

        requestAnimationFrame(() => {
          barExp.style.width = `${expPercent}%`;
          barInc.style.width = `${incPercent}%`;
        });

        pair.appendChild(barExp);
        pair.appendChild(barInc);
        wrap.appendChild(pair);

        const value = document.createElement("div");
        value.className = "chart-value";
        const balance = incVal - expVal;
        const sign = balance > 0 ? "+" : balance < 0 ? "‚Äì" : "";
        value.textContent =
          `–†: ${expVal.toLocaleString("ru-RU")} / –î: ${incVal.toLocaleString("ru-RU")} (${sign}${Math.abs(balance).toLocaleString("ru-RU")})`;

        row.appendChild(label);
        row.appendChild(wrap);
        row.appendChild(value);
        chartEl.appendChild(row);
      });
    }

    // ---------- favorites ----------
    function toggleFavoriteCategory() {
      const cat = document.getElementById("categoryExp")?.value;
      if (!cat) return;

      const idx = favoriteCategories.indexOf(cat);
      if (idx >= 0) favoriteCategories.splice(idx, 1);
      else favoriteCategories.unshift(cat);

      favoriteCategories = Array.from(new Set(favoriteCategories)).slice(0, 10);
      saveFavorites();
      renderFavoriteChips();
    }

    function renderFavoriteChips() {
      const el = document.getElementById("favChips");
      if (!el) return;

      el.innerHTML = "";
      if (!favoriteCategories.length) {
        el.innerHTML = `<div class="list-empty">–ü–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö. –í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ ‚Äú–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥‚Äù –∏ –Ω–∞–∂–º–∏ ‚òÜ</div>`;
        return;
      }

      favoriteCategories.forEach(cat => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = cat;
        chip.onclick = () => {
          const sel = document.getElementById("categoryExp");
          if (sel) {
            sel.value = cat;
            autoKindByCategory();
          }
          const amount = document.getElementById("amountExp");
          if (amount) amount.focus();
        };
        el.appendChild(chip);
      });
    }

    // ---------- list filters ----------
    function onFiltersChanged() {
      uiFilters.q = (document.getElementById("q")?.value || "").trim().toLowerCase();
      uiFilters.type = document.getElementById("fType")?.value || "all";
      uiFilters.cat = document.getElementById("fCat")?.value || "all";
      uiFilters.sort = document.getElementById("fSort")?.value || "date_desc";
      render();
    }

    function resetFilters() {
      const q = document.getElementById("q");
      const t = document.getElementById("fType");
      const c = document.getElementById("fCat");
      const s = document.getElementById("fSort");

      if (q) q.value = "";
      if (t) t.value = "all";
      if (c) c.value = "all";
      if (s) s.value = "date_desc";

      uiFilters.q = "";
      uiFilters.type = "all";
      uiFilters.cat = "all";
      uiFilters.sort = "date_desc";

      render();
    }

    function refreshCategoryFilterOptions() {
      const sel = document.getElementById("fCat");
      if (!sel) return;

      const cats = Array.from(new Set(expenses.map(e => String(e.category || "–î—Ä—É–≥–æ–µ"))))
        .filter(Boolean)
        .sort((a,b)=>a.localeCompare(b, "ru"));

      const current = sel.value || "all";
      sel.innerHTML =
        `<option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>` +
        cats.map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join("");

      sel.value = cats.includes(current) ? current : "all";
    }

    function applyFiltersToList(list) {
      let out = list.slice();

      if (uiFilters.type !== "all") {
        out = out.filter(e => (e.type || "expense") === uiFilters.type);
      }

      if (uiFilters.cat !== "all") {
        out = out.filter(e => String(e.category || "") === uiFilters.cat);
      }

      if (uiFilters.q) {
        out = out.filter(e => {
          const hay = [
            e.type || "",
            e.category || "",
            e.kind || "",
            e.desc || "",
            e.date || "",
            String(e.amount ?? "")
          ].join(" ").toLowerCase();
          return hay.includes(uiFilters.q);
        });
      }

      const safeDate = (iso) => {
        const d = new Date(iso || "");
        const t = d.getTime();
        return Number.isNaN(t) ? 0 : t;
      };

      if (uiFilters.sort === "date_desc") out.sort((a,b)=> safeDate(b.date) - safeDate(a.date));
      else if (uiFilters.sort === "date_asc") out.sort((a,b)=> safeDate(a.date) - safeDate(b.date));
      else if (uiFilters.sort === "amount_desc") out.sort((a,b)=> (Number(b.amount)||0) - (Number(a.amount)||0));
      else if (uiFilters.sort === "amount_asc") out.sort((a,b)=> (Number(a.amount)||0) - (Number(b.amount)||0));

      return out;
    }

    // ---------- goals ----------
    function addGoal() {
      const nameEl = document.getElementById("goalName");
      const targetEl = document.getElementById("goalTarget");
      const name = (nameEl.value || "").trim();
      const target = Number(targetEl.value) || 0;

      if (!name) { alert("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏"); return; }
      if (target <= 0) { alert("–í–≤–µ–¥–∏ —Å—É–º–º—É —Ü–µ–ª–∏"); return; }

      goals.push({
        id: Date.now() + Math.random().toString(16).slice(2),
        name,
        target,
        saved: 0,
        createdAt: new Date().toISOString(),
      });

      saveGoals();
      nameEl.value = "";
      targetEl.value = "";
      renderGoals();
      renderInsights();
    }

    function clearGoals() {
      if (!goals.length) return;
      if (confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ü–µ–ª–∏?")) {
        goals = [];
        saveGoals();
        renderGoals();
        renderInsights();
      }
    }

    function addToGoal(goalId) {
      const input = document.getElementById(`goalAdd-${goalId}`);
      const amount = Number(input.value) || 0;
      if (amount <= 0) { alert("–í–≤–µ–¥–∏ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è"); return; }

      goals = goals.map(g => {
        if (g.id !== goalId) return g;
        return { ...g, saved: Math.max(0, (Number(g.saved) || 0) + amount) };
      });

      saveGoals();
      input.value = "";
      renderGoals();
      renderInsights();
    }

    function deleteGoal(goalId) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å?")) return;
      goals = goals.filter(g => g.id !== goalId);
      saveGoals();
      renderGoals();
      renderInsights();
    }

    function renderGoals() {
      const list = document.getElementById("goalsList");
      const clearBtn = document.getElementById("clearGoalsBtn");
      if (!list) return;

      list.innerHTML = "";
      if (clearBtn) clearBtn.disabled = goals.length === 0;

      if (!goals.length) {
        list.innerHTML = `<div class="list-empty">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é ‚Äî –∏ –Ω–∞—á–Ω—ë—Ç—Å—è –º–∞–≥–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ‚ú®</div>`;
        return;
      }

      goals.forEach(g => {
        const saved = Number(g.saved) || 0;
        const target = Number(g.target) || 0;
        const pct = target > 0 ? Math.min(100, (saved / target) * 100) : 0;

        const wrap = document.createElement("div");
        wrap.className = "goal";

        wrap.innerHTML = `
          <div class="goal-title">
            <b>${escapeHTML(g.name)}</b>
            <span>${saved.toLocaleString("ru-RU")} / ${target.toLocaleString("ru-RU")} ‚ÇΩ</span>
          </div>
          <div class="goal-sub">
            –ü—Ä–æ–≥—Ä–µ—Å—Å: ${pct.toFixed(1)}% ¬∑ –û—Å—Ç–∞–ª–æ—Å—å: ${Math.max(0, target - saved).toLocaleString("ru-RU")} ‚ÇΩ
          </div>
          <div class="goal-bar"><div style="width:${pct}%;"></div></div>

          <div class="goal-actions">
            <input id="goalAdd-${g.id}" type="number" min="1" placeholder="–ü–æ–ø–æ–ª–Ω–∏—Ç—å, ‚ÇΩ" />
            <button class="btn-primary" onclick="addToGoal('${g.id}')">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="btn-secondary" onclick="deleteGoal('${g.id}')">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;

        list.appendChild(wrap);
      });
    }

    // ---------- export / import ----------
    function exportJSON() {
      const payload = {
        exportedAt: new Date().toISOString(),
        version: 1,
        settings,
        goals,
        expenses
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `grimuar-finance-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      const header = ["type","date","amount","category","kind","desc"].join(",");
      const rows = expenses.map(e => [
        csvSafe(e.type || ""),
        csvSafe(e.date || ""),
        csvSafe(String(e.amount ?? "")),
        csvSafe(e.category || ""),
        csvSafe(e.kind || ""),
        csvSafe(e.desc || "")
      ].join(","));

      const csv = [header, ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `grimuar-finance-ops-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSONFile(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const merge = !!document.getElementById("importMerge")?.checked;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result || "{}"));

          const incomingExpenses = Array.isArray(parsed) ? parsed : (parsed.expenses || []);
          const incomingGoals = Array.isArray(parsed.goals) ? parsed.goals : [];
          const incomingSettings = parsed.settings && typeof parsed.settings === "object" ? parsed.settings : null;

          if (!Array.isArray(incomingExpenses)) {
            alert("–§–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –±—ç–∫–∞–ø (–Ω–µ—Ç –º–∞—Å—Å–∏–≤–∞ expenses).");
            return;
          }

          const cleaned = incomingExpenses
            .filter(x => x && typeof x === "object")
            .map(x => ({
              id: x.id || (Date.now() + Math.random().toString(16).slice(2)),
              type: x.type === "income" ? "income" : "expense",
              date: x.date || todayISO(),
              amount: Number(x.amount) || 0,
              category: String(x.category || (x.type === "income" ? "–î—Ä—É–≥–æ–µ" : "–î—Ä—É–≥–æ–µ")),
              kind: String(x.kind || (x.type === "income" ? "–î–æ—Ö–æ–¥" : "–ë–∞–∑–æ–≤—ã–µ")),
              desc: String(x.desc || "")
            }))
            .filter(x => x.amount > 0);

          if (!cleaned.length) {
            alert("–í –±—ç–∫–∞–ø–µ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.");
            return;
          }

          if (!confirm(merge ? `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –î–û–ë–ê–í–ò–¢–¨ ${cleaned.length} –æ–ø–µ—Ä–∞—Ü–∏–π?` : `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ó–ê–ú–ï–ù–ò–¢–¨ –¥–∞–Ω–Ω—ã–µ (${cleaned.length} –æ–ø–µ—Ä–∞—Ü–∏–π)?`)) {
            return;
          }

          if (merge) {
            expenses = [...expenses, ...cleaned];
          } else {
            expenses = cleaned;
            if (incomingSettings) settings = { ...settings, ...incomingSettings };
            goals = incomingGoals.map(g => ({
              id: g.id || (Date.now() + Math.random().toString(16).slice(2)),
              name: String(g.name || "–¶–µ–ª—å"),
              target: Number(g.target) || 0,
              saved: Number(g.saved) || 0,
              createdAt: g.createdAt || new Date().toISOString()
            })).filter(g => g.target > 0);
          }

          saveExpenses();
          saveSettings();
          saveGoals();
          syncSettingsToUI();
          render();
          renderGoals();
          renderInsights();
          alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ");
        } catch (e) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å JSON. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª.");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    }

    // ---------- insights ----------
    function renderInsights() {
      const box = document.getElementById("insightsBox");
      if (!box) return;

      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();
      const startThis = new Date(y, m, 1);
      const startNext = new Date(y, m + 1, 1);
      const startPrev = new Date(y, m - 1, 1);

      function inRange(iso, a, b) {
        const d = new Date(iso);
        return !Number.isNaN(d.getTime()) && d >= a && d < b;
      }

      const thisMonth = expenses.filter(e => inRange(e.date || "", startThis, startNext));
      const prevMonth = expenses.filter(e => inRange(e.date || "", startPrev, startThis));

      const expThis = thisMonth.filter(e => (e.type || "expense") !== "income");
      const incThis = thisMonth.filter(e => (e.type || "") === "income");
      const sumExpThis = expThis.reduce((s, e) => s + (Number(e.amount) || 0), 0);
      const sumIncThis = incThis.reduce((s, e) => s + (Number(e.amount) || 0), 0);
      const balThis = sumIncThis - sumExpThis;

      const expPrev = prevMonth.filter(e => (e.type || "expense") !== "income");
      const sumExpPrev = expPrev.reduce((s, e) => s + (Number(e.amount) || 0), 0);

      const dayOfMonth = today.getDate();
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const avgPerDay = dayOfMonth > 0 ? (sumExpThis / dayOfMonth) : 0;
      const forecast = avgPerDay * daysInMonth;
      const forecastOver = (settings.monthlyBudget || 0) > 0 ? (forecast - (settings.monthlyBudget || 0)) : null;

      const byCat = {};
      expThis.forEach(e => {
        const c = e.category || "–î—Ä—É–≥–æ–µ";
        byCat[c] = (byCat[c] || 0) + (Number(e.amount) || 0);
      });
      const top = Object.entries(byCat).sort((a,b)=>b[1]-a[1])[0];

      const byDow = {};
      expThis.forEach(e => {
        const d = new Date(e.date || "");
        if (Number.isNaN(d.getTime())) return;
        const dow = d.getDay();
        byDow[dow] = (byDow[dow] || 0) + (Number(e.amount) || 0);
      });
      const dowNames = ["–≤—Å","–ø–Ω","–≤—Ç","—Å—Ä","—á—Ç","–ø—Ç","—Å–±"];
      const topDow = Object.entries(byDow).sort((a,b)=>b[1]-a[1])[0];

      const diff = sumExpThis - sumExpPrev;
      const diffPct = sumExpPrev > 0 ? (diff / sumExpPrev) * 100 : null;

      const goalSumTarget = goals.reduce((s,g)=> s + (Number(g.target)||0), 0);
      const goalSumSaved  = goals.reduce((s,g)=> s + (Number(g.saved)||0), 0);

      const lines = [];
      lines.push(`üìö <b>–≠—Ç–æ—Ç –º–µ—Å—è—Ü</b>: —Ä–∞—Å—Ö–æ–¥—ã <b>${sumExpThis.toLocaleString("ru-RU")} ‚ÇΩ</b>, –¥–æ—Ö–æ–¥—ã <b>${sumIncThis.toLocaleString("ru-RU")} ‚ÇΩ</b>, –±–∞–ª–∞–Ω—Å <b>${balThis.toLocaleString("ru-RU")} ‚ÇΩ</b>.`);

      if (sumExpPrev > 0) {
        const sign = diff > 0 ? "+" : "";
        lines.push(`üï∞Ô∏è <b>–ö –ø—Ä–æ—à–ª–æ–º—É –º–µ—Å—è—Ü—É</b>: ${sign}${diff.toLocaleString("ru-RU")} ‚ÇΩ (${diffPct.toFixed(1)}%).`);
      } else {
        lines.push(`üï∞Ô∏è <b>–ö –ø—Ä–æ—à–ª–æ–º—É –º–µ—Å—è—Ü—É</b>: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.`);
      }

      if (top) {
        const share = sumExpThis > 0 ? (top[1] / sumExpThis) * 100 : 0;
        lines.push(`ü™ô <b>–¢–æ–ø-–∫–∞—Ç–µ–≥–æ—Ä–∏—è</b>: ¬´${escapeHTML(top[0])}¬ª ‚Äî ${top[1].toLocaleString("ru-RU")} ‚ÇΩ (${share.toFixed(1)}%).`);
      }

      if (topDow) {
        lines.push(`üìÖ <b>–°–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏</b>: ${dowNames[Number(topDow[0])] } ‚Äî ${Number(topDow[1]).toLocaleString("ru-RU")} ‚ÇΩ.`);
      }

      lines.push(`üîÆ <b>–ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</b> –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞: ~${Math.round(forecast).toLocaleString("ru-RU")} ‚ÇΩ.`);
      if ((settings.monthlyBudget || 0) > 0 && forecastOver !== null) {
        if (forecastOver > 0) lines.push(`‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑: –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥ –±—é–¥–∂–µ—Ç–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ <b>${Math.round(forecastOver).toLocaleString("ru-RU")} ‚ÇΩ</b>.`);
        else lines.push(`‚úÖ –ü—Ä–æ–≥–Ω–æ–∑: –≤ –±—é–¥–∂–µ—Ç–µ, –∑–∞–ø–∞—Å ~<b>${Math.abs(Math.round(forecastOver)).toLocaleString("ru-RU")} ‚ÇΩ</b>.`);
      }

      if (goalSumTarget > 0) {
        const pct = Math.min(100, (goalSumSaved / goalSumTarget) * 100);
        lines.push(`üéØ <b>–¶–µ–ª–∏</b>: –Ω–∞–∫–æ–ø–ª–µ–Ω–æ ${goalSumSaved.toLocaleString("ru-RU")} ‚ÇΩ –∏–∑ ${goalSumTarget.toLocaleString("ru-RU")} ‚ÇΩ (${pct.toFixed(1)}%).`);
      }

      box.innerHTML = lines.join("<br>") + `<small>–ü–æ–¥—Å–∫–∞–∑–∫–∞: —á–µ–º –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö —Ç—ã –≤–Ω–µ—Å—ë—à—å, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è ‚ú®</small>`;
    }

    // ---------- kind auto ----------
    function autoKindByCategory() {
      const cat = document.getElementById("categoryExp").value;
      const kindSelect = document.getElementById("kindExp");
      const essential = ["–ü—Ä–æ–¥—É–∫—Ç—ã", "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ê–≤—Ç–æ", "–°–≤—è–∑—å/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–î–æ–º/–±—ã—Ç"];
      kindSelect.value = essential.includes(cat) ? "–ë–∞–∑–æ–≤—ã–µ" : "–ì–∏–±–∫–∏–µ";
    }

    // ---------- add ops ----------
    function addExpense() {
      const amountInput = document.getElementById("amountExp");
      const dateInput = document.getElementById("dateExp");
      const categoryInput = document.getElementById("categoryExp");
      const kindInput = document.getElementById("kindExp");
      const descInput = document.getElementById("descExp");

      const amount = Number(amountInput.value);
      const date = dateInput.value || todayISO();
      const category = categoryInput.value;
      const kind = kindInput.value || "–ë–∞–∑–æ–≤—ã–µ";
      const desc = descInput.value.trim();

      if (!amount || amount <= 0) {
        alert("–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞");
        return;
      }

      const exp = {
        id: Date.now() + Math.random().toString(16).slice(2),
        amount,
        date,
        category,
        kind,
        type: "expense",
        desc,
      };

      expenses.push(exp);
      saveExpenses();
      render();

      amountInput.value = "";
      descInput.value = "";
    }

    function addIncome() {
      const amountInput = document.getElementById("amountInc");
      const dateInput = document.getElementById("dateInc");
      const categoryInput = document.getElementById("categoryInc");
      const descInput = document.getElementById("descInc");

      const amount = Number(amountInput.value);
      const date = dateInput.value || todayISO();
      const category = categoryInput.value;
      const desc = descInput.value.trim();

      if (!amount || amount <= 0) {
        alert("–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞");
        return;
      }

      const inc = {
        id: Date.now() + Math.random().toString(16).slice(2),
        amount,
        date,
        category,
        kind: "–î–æ—Ö–æ–¥",
        type: "income",
        desc,
      };

      expenses.push(inc);
      saveExpenses();
      render();

      amountInput.value = "";
      descInput.value = "";
    }

    function clearAll() {
      if (!expenses.length) return;
      if (confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–ø–∏—Å–∏?")) {
        expenses = [];
        saveExpenses();
        render();
      }
    }

    // ---------- splash ----------
    function hideSplash() {
      const splash = document.getElementById("splash");
      if (!splash) return;
      setTimeout(() => {
        splash.classList.add("splash-hidden");
        setTimeout(() => {
          if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
        }, 800);
      }, 350);
    }

    // ---------- render ----------
    function render() {
      const listEl = document.getElementById("list");
      const totalEl = document.getElementById("totalAmount");
      const totalLabelEl = document.getElementById("totalLabel");
      const catsEl = document.getElementById("cats");
      const hintEl = document.getElementById("hint");
      const clearBtn = document.getElementById("clearBtn");
      const opsCountEl = document.getElementById("opsCount");
      const avgInfoEl = document.getElementById("avgInfo");
      const incomeInfoEl = document.getElementById("incomeInfo");
      const kindStatsEl = document.getElementById("kindStats");
      const budgetBar = document.getElementById("budgetBar");
      const budgetInfoEl = document.getElementById("budgetInfo");

      listEl.innerHTML = "";
      catsEl.innerHTML = "";
      hintEl.innerHTML = "";
      opsCountEl.textContent = "";
      avgInfoEl.textContent = "";
      incomeInfoEl.textContent = "";
      kindStatsEl.innerHTML = "";
      document.getElementById("chartCats").innerHTML = "";
      document.getElementById("chartDays").innerHTML = "";

      const budgetWarnings = updateBudgetUI(budgetBar, budgetInfoEl);

      const filtered = getPeriodFilteredExpenses();
      refreshCategoryFilterOptions();
      const filteredForList = applyFiltersToList(filtered);

      clearBtn.disabled = expenses.length === 0;

      // –µ—Å–ª–∏ –ø–æ –ø–µ—Ä–∏–æ–¥—É –≤–æ–æ–±—â–µ –ø—É—Å—Ç–æ ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–∂–µ –ø—É—Å—Ç–∞—è
      if (filtered.length === 0) {
        listEl.innerHTML =
          '<div class="list-empty">–ü–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –æ –¥–æ—Ö–æ–¥–µ –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥–µ üëá</div>';
        totalEl.textContent = "0 ‚ÇΩ";
        totalLabelEl.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥";
        if (budgetWarnings.length) hintEl.innerHTML = budgetWarnings.join("<br>");
        renderGoals();
        renderInsights();
        renderFavoriteChips();
        hideSplash();
        return;
      }

      // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É
      let totalExpenses = 0;
      let totalIncome = 0;
      let expenseCount = 0;
      let incomeCount = 0;

      const byCategory = {};
      const byKind = {};
      const byDateExp = {};
      const byDateInc = {};
      const daysSet = new Set();

      filtered.forEach((e) => {
        const amount = Number(e.amount) || 0;
        const type = e.type || "expense";
        const dateStr = e.date || todayISO();

        if (type === "income") {
          totalIncome += amount;
          incomeCount += 1;
          byDateInc[dateStr] = (byDateInc[dateStr] || 0) + amount;
        } else {
          totalExpenses += amount;
          expenseCount += 1;

          byCategory[e.category] = (byCategory[e.category] || 0) + amount;
          const kindKey = e.kind || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
          byKind[kindKey] = (byKind[kindKey] || 0) + amount;

          byDateExp[dateStr] = (byDateExp[dateStr] || 0) + amount;
          daysSet.add(dateStr);
        }
      });

      totalEl.textContent = `${totalExpenses.toLocaleString("ru-RU")} ‚ÇΩ`;

      const periodName = {
        all: "–∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
        today: "–∑–∞ —Å–µ–≥–æ–¥–Ω—è",
        month: "–∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü",
      }[document.getElementById("period").value];

      totalLabelEl.textContent = `–†–∞—Å—Ö–æ–¥—ã ${periodName}`;
      opsCountEl.textContent = `–û–ø–µ—Ä–∞—Ü–∏–π: ${filtered.length} (—Ä–∞—Å—Ö–æ–¥—ã: ${expenseCount}, –¥–æ—Ö–æ–¥—ã: ${incomeCount})`;

      const daysCount = Math.max(daysSet.size, 1);
      const avgPerDay = totalExpenses / daysCount;
      avgInfoEl.textContent = `–°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã ~${Math.round(avgPerDay).toLocaleString("ru-RU")} ‚ÇΩ –≤ –¥–µ–Ω—å (–¥–Ω–µ–π —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏: ${daysCount})`;

      const balance = totalIncome - totalExpenses;
      incomeInfoEl.textContent = `–î–æ—Ö–æ–¥—ã: ${totalIncome.toLocaleString("ru-RU")} ‚ÇΩ, –±–∞–ª–∞–Ω—Å –∑–∞ –ø–µ—Ä–∏–æ–¥: ${balance.toLocaleString("ru-RU")} ‚ÇΩ`;

      Object.keys(byCategory).sort((a,b)=>a.localeCompare(b,"ru")).forEach((cat) => {
        const row = document.createElement("div");
        const left = document.createElement("span");
        const right = document.createElement("span");

        left.textContent = cat;
        right.textContent = `${byCategory[cat].toLocaleString("ru-RU")} ‚ÇΩ`;

        row.appendChild(left);
        row.appendChild(right);
        catsEl.appendChild(row);
      });

      Object.keys(byKind).sort((a,b)=>a.localeCompare(b,"ru")).forEach((k) => {
        const v = byKind[k];
        const row = document.createElement("div");
        const left = document.createElement("span");
        const right = document.createElement("span");
        const share = totalExpenses ? (v / totalExpenses) * 100 : 0;
        left.textContent = k;
        right.textContent = `${v.toLocaleString("ru-RU")} ‚ÇΩ (${share.toFixed(1)}%)`;
        row.appendChild(left);
        row.appendChild(right);
        kindStatsEl.appendChild(row);
      });

      // hint
      let hintParts = [];
      const topCat = Object.entries(byCategory).sort((a,b)=>b[1]-a[1])[0];
      if (topCat && totalExpenses > 0) {
        const share = ((topCat[1] / totalExpenses) * 100).toFixed(1);
        hintParts.push(`–°–∞–º–∞—è –∫—Ä—É–ø–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: ¬´${escapeHTML(topCat[0])}¬ª ‚Äî ${topCat[1].toLocaleString("ru-RU")} ‚ÇΩ (${share}%).`);
      }
      if (budgetWarnings.length) hintParts = hintParts.concat(budgetWarnings);
      if (hintParts.length) hintEl.innerHTML = hintParts.join("<br>");

      // charts
      renderCategoryChart(byCategory, totalExpenses);
      renderDayOverlapChart(byDateExp, byDateInc);

      // list (—É–∂–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π)
      if (filteredForList.length === 0) {
        listEl.innerHTML = '<div class="list-empty">–ü–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>';
      } else {
        filteredForList.forEach((e) => {
          const id = e.id;
          const amount = Number(e.amount) || 0;
          const type = e.type || "expense";
          const dateStr = e.date || todayISO();

          const item = document.createElement("div");
          item.className = "item";

          const main = document.createElement("div");
          main.className = "item-main";

          const line1 = document.createElement("div");
          line1.className = "item-line1";

          const amountSpan = document.createElement("span");
          amountSpan.className = "item-amount";
          amountSpan.textContent = `${amount.toLocaleString("ru-RU")} ‚ÇΩ`;
          if (type === "expense") amountSpan.classList.add("expense");

          const catSpan = document.createElement("span");
          catSpan.className = "item-cat";
          catSpan.textContent = e.category || "‚Äî";

          const kindSpan = document.createElement("span");
          kindSpan.className = "item-kind";
          kindSpan.textContent = (type === "expense" && e.kind) ? `¬∑ ${e.kind}` : "";

          const typeTag = document.createElement("span");
          typeTag.className = "item-type-tag";
          typeTag.textContent = type === "income" ? "–î–æ—Ö–æ–¥" : "–†–∞—Å—Ö–æ–¥";

          const catKindWrapper = document.createElement("span");
          catKindWrapper.appendChild(catSpan);
          if (e.kind && type === "expense") catKindWrapper.appendChild(kindSpan);
          catKindWrapper.appendChild(typeTag);

          line1.appendChild(amountSpan);
          line1.appendChild(catKindWrapper);

          const desc = document.createElement("div");
          desc.className = "item-desc";
          desc.textContent = e.desc ? e.desc : "‚Äî";

          const date = document.createElement("div");
          date.className = "item-date";
          date.textContent = formatDateRu(dateStr);

          main.appendChild(line1);
          main.appendChild(desc);
          main.appendChild(date);

          const delBtn = document.createElement("button");
          delBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
          delBtn.onclick = function () {
            if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
              expenses = expenses.filter((x) => x.id !== id);
              saveExpenses();
              render();
            }
          };

          item.appendChild(main);
          item.appendChild(delBtn);
          listEl.appendChild(item);
        });
      }

      renderGoals();
      renderInsights();
      renderFavoriteChips();
      hideSplash();
    }

    // ---------- service worker ----------
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .catch((err) => console.log("SW registration failed", err));
      });
    }

    // ---------- init ----------
    loadExpenses();
    loadSettings();
    loadGoals();
    loadFavorites();

    document.getElementById("dateExp").value = todayISO();
    document.getElementById("dateInc").value = todayISO();
    autoKindByCategory();
    syncSettingsToUI();

    render();
  </script>
</body>
</html>
